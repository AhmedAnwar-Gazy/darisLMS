@startuml

' Color Customization
skinparam {
    BackgroundColor white
    ArrowColor #4C5FD5
    
    ' Activity Diagram specific
    ActivityBackgroundColor white
    ActivityBorderColor #4C5FD5
    ActivityStartColor #4C5FD5
    ActivityEndColor #4C5FD5
    ActivityBarColor #4C5FD5
    ActivityDiamondBackgroundColor white
    ActivityDiamondBorderColor #4C5FD5
    
    ' Notes
    NoteBackgroundColor #FBBF24
    NoteBorderColor #FBBF24
    
    ' Error/Warning (custom styles if needed)
    ' Error: #EF4444
}


title Scheduled System Maintenance
skinparam activityBackgroundColor #FAF0E6
skinparam activityBorderColor #8B7355

|System Timer|
start
:Trigger Every Minute\n(Linux Cron);

|Laravel Scheduler|
:Check task_scheduled Table;
:Identify Due Tasks;

fork
  |Worker 1|
  :Clean Expired Tokens;
  :DELETE FROM personal_access_tokens\nWHERE expires_at < NOW();
  
fork again
  |Worker 2|
  :Process Email Queue;
  :SELECT * FROM mail_queue\nWHERE status='pending';
  :Send via SMTP;
  :UPDATE status='sent';
  
fork again
  |Worker 3|
  :Recalculate Analytics;
  :Aggregate Course Statistics;
  :Update Analytics Cache;
end fork

|Laravel Scheduler|
:Synchronize Worker Results;

if (Any Task Failed?) then (yes)
  :Log Error to task_log;
  :Increment faildelay;
  :Schedule Retry;
else (no)
  :Update lastruntime;
endif

:Release Task Locks;

|Database|
:UPDATE task_scheduled\nSET lastruntime=NOW();
:INSERT INTO task_log\nfor audit trail;
-back->

stop
@enduml